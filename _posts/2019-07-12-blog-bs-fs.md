---
title: 'Coordinate transform between freesurfer and brainstorm'
date: 2019-07-12
permalink: /posts/2019/9/fs_bs/
categories:
  - Tools
---


## Brainstorm & freesurfer if using the same MRI
Assume that we have imported the ```T1.mgz``` generated by the freesurfer into the Brainstorm, and use that as our Brainstorm subject MRI. Then, we have some points for this subject that we want to plot together with the freesurfer cortex (```*h.pial```) in Matlab.
1. Read the files: 
Export Brainstorm MRI to Matlab (Variable name: ```sMri```). Read freesurfer cortext file into Matlab using ```mne_read_surface``` (comes with Brainstorm) or ```freesurfer_read_surf``` from [bioelectromagnetism](https://github.com/dazza-codes/bioelectromagnetism). Those two function is the same, but the first function returns coordinate in unit ```m```, while the latter returns in unit ```mm```.
```
[verts1, faces1] = mne_read_surface('lh.pial');
[verts2, faces2] = mne_read_surface('rh.pial');
verts = [verts1;verts2];
faces = [faces1;faces2];
```
2. Shift
```
pos_bs2 = bst_bsxfun(@plus, verts, (size(sMri.Cube)/2 + [0 1 0]) .* sMri.Voxsize / 1000);
```
3. Transform
```
pos_bs = cs_convert(mri, 'mri', 'scs', pos_bs2);
```
So to go back from brainstorm to freesurfer coordinates, we need
```
pos_fs = cs_convert(mri, 'scs', 'mri', bs.Vertices);
pos = bst_bsxfun(@minus, pos_fs, (size(sMri.Cube)/2 + [0 1 0]) .* sMri.Voxsize / 1000)*1000; 
```

## Brainstorm & freesurfer using different MRI (Needs further exploration)
If the we have a subject with iEEG locations coregistered with the MRI, and we need to export the Brainstorm MRI to be processed by freesufer MRI then coregister the iEEG locations and ```*h.pial```. From what I know, since ```T1.mgz``` is a transformation and a reslice of the original MRI ```rawavg.mgz```, to perfectly match all the sulcus and gyrus, using the methods above will not work. Theoretically speaking, we only need to map the ```*h.pial``` to the same MRI. Using 
```
tkregister2 --mov rawavg.mgz --targ T1.mgz --reg register.native.dat --noedit --regheader
mri_surf2surf --sval-xyz pial --reg register.native.dat rawavg.mgz --tval lh.pial.native --tval-xyz rawavg.mgz --hemi lh --s subjectname
```
can map ```*h.pial``` to the original MRI space. Then, use the same way to process the ```*h.pial.native```, we should be able to map between the two software. 

However, from my experiments: 
1. We need to use a coronal sliced MRI as the freesurfer input. When use ```mri_info``` in freesufer to check the ```rawavg.mgz```, it should be in ```LIA``` coordinate (the same as the coordinate of ```T1.mgz```). If the ```rawavg.mgz``` is in ```RAS``` or others, it will not work.
2. Use the *import surfaces* and *check MRI/surface coregisteration* in Matlab, the sulcus and gyrus can match perfectly with the MRI. However, if I plot the CAT cortex and freesurfer cortex in Matlab in the command line, there seems to be small coordinate shift. Also, if I import ```*h.pial.native``` into Curry 8 and *import  to MRI*, I can also observe this coordinate shift. I am not certain about the reason. 

### References:
1. [The code for import surface mesh in brainstorm](https://github.com/brainstorm-tools/brainstorm3/blob/5f58d6a314209a5ba4fbd7b7e7caeda45e12e5eb/toolbox/io/in_tess.m#L162)
2. [Freesurfer to native anatomy](https://surfer.nmr.mgh.harvard.edu/fswiki/FsAnat-to-NativeAnat)

